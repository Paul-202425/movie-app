@'
global
  log stdout format raw local0
  maxconn 2048

defaults
  log     global
  mode    http
  option  httplog
  option  dontlognull
  timeout connect 5s
  timeout client  30s
  timeout server  30s
  option  http-server-close

frontend fe_http
  bind *:8080
  acl is_api path_beg /api
  use_backend be_api if is_api
  default_backend be_web

backend be_web
  balance roundrobin
  option httpchk GET /
  http-check expect status 200
  server web01 web01-frontend:80 check
  server web02 web02-frontend:80 check

backend be_api
  balance roundrobin
  option httpchk GET /health
  http-check expect status 200

  # âœ¨ rewrite only the health endpoint
  acl is_api_health path -i /api/health
  http-request set-path /health if is_api_health

  server api01 web01-backend:5000 check
  server api02 web02-backend:5000 check
'@ | Set-Content haproxy.cfg

# reload HAProxy (it reads the file on start)
docker restart lb-haproxy
